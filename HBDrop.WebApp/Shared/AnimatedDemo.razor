@using System.Timers
@inject IJSRuntime JS
@implements IDisposable

<div class="demo-phone">
    <div class="demo-screen">
        <!-- WhatsApp header -->
        <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
            <div class="rounded-circle bg-success position-relative" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                <span style="font-size: 1.5rem;">üë§</span>
                @if (showNotification)
                {
                    <div class="notification-badge">1</div>
                }
            </div>
            <div>
                <div class="fw-bold">@ContactName</div>
                <small class="text-muted">@(isTyping ? "typing..." : "Online")</small>
            </div>
        </div>

        <!-- Messages container -->
        <div class="messages-container">
            @foreach (var msg in messages)
            {
                <div class="message-bubble message-appear @(msg.IsRead ? "celebration" : "")">
                    @msg.Text
                    <div class="message-status">
                        @if (msg.IsSent)
                        {
                            <span class="checkmark">‚úì</span>
                        }
                        @if (msg.IsDelivered)
                        {
                            <span class="checkmark">‚úì</span>
                        }
                        @if (msg.IsRead)
                        {
                            <span class="checkmark read-checkmark">‚úì‚úì</span>
                        }
                    </div>
                </div>
            }

            @if (isTyping)
            {
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            }
        </div>

        @if (messages.Count > 0 && messages.Count >= 3 && messages.Last().IsRead)
        {
            <div class="text-center mt-4">
                <small class="text-success fw-bold">‚ú® Birthday wish delivered! ‚ú®</small>
            </div>
        }
    </div>
</div>

<!-- Demo Timeline -->
<div class="demo-timeline mt-4">
    <div class="timeline-step @(currentStep >= 0 ? "completed" : "") @(currentStep == 0 ? "active" : "")">
        <div class="timeline-icon">üìÖ</div>
        <div class="timeline-label">Birthday</div>
    </div>
    <div class="timeline-step @(currentStep >= 1 ? "completed" : "") @(currentStep == 1 ? "active" : "")">
        <div class="timeline-icon">ü§ñ</div>
        <div class="timeline-label">Auto Send</div>
    </div>
    <div class="timeline-step @(currentStep >= 2 ? "completed" : "") @(currentStep == 2 ? "active" : "")">
        <div class="timeline-icon">üì±</div>
        <div class="timeline-label">Delivered</div>
    </div>
    <div class="timeline-step @(currentStep >= 3 ? "completed" : "") @(currentStep == 3 ? "active" : "")">
        <div class="timeline-icon">‚úÖ</div>
        <div class="timeline-label">Read</div>
    </div>
</div>

@code {
    [Parameter]
    public string ContactName { get; set; } = "Sarah Johnson";

    [Parameter]
    public int Age { get; set; } = 25;

    private List<DemoMessage> messages = new();
    private bool isTyping = false;
    private bool showNotification = false;
    private int currentStep = -1;
    private Timer? _timer;
    private int _tickCount = 0;

    private class DemoMessage
    {
        public string Text { get; set; } = "";
        public bool IsSent { get; set; }
        public bool IsDelivered { get; set; }
        public bool IsRead { get; set; }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            // Start timer after component is fully rendered
            _timer = new Timer(500); // Tick every 500ms
            _timer.Elapsed += OnTimerTick;
            _timer.AutoReset = true;
            _timer.Start();
        }
    }

    private void OnTimerTick(object? sender, ElapsedEventArgs e)
    {
        _tickCount++;
        
        InvokeAsync(() =>
        {
            UpdateDemoState(_tickCount);
            StateHasChanged();
        });
    }

    private void UpdateDemoState(int tick)
    {
        // Reset every 30 ticks (15 seconds)
        int cyclePosition = tick % 30;
        
        if (cyclePosition == 0)
        {
            // Reset
            messages.Clear();
            isTyping = false;
            showNotification = false;
            currentStep = -1;
        }
        else if (cyclePosition == 1)
        {
            // Step 1: Birthday
            currentStep = 0;
        }
        else if (cyclePosition == 2)
        {
            currentStep = 1;
        }
        else if (cyclePosition == 3)
        {
            // Start typing
            isTyping = true;
        }
        else if (cyclePosition == 5)
        {
            // First message appears
            isTyping = false;
            messages.Add(new DemoMessage 
            { 
                Text = $"üéâ Happy Birthday, {ContactName.Split(' ')[0]}! üéÇ",
                IsSent = true,
                IsDelivered = false,
                IsRead = false
            });
        }
        else if (cyclePosition == 7)
        {
            // Start typing second message
            isTyping = true;
        }
        else if (cyclePosition == 10)
        {
            // Second message appears
            isTyping = false;
            messages.Add(new DemoMessage 
            { 
                Text = $"Wishing you an amazing {Age}th birthday filled with joy, laughter, and wonderful memories! üéà‚ú®",
                IsSent = true,
                IsDelivered = false,
                IsRead = false
            });
        }
        else if (cyclePosition == 12)
        {
            // Start typing third message
            isTyping = true;
        }
        else if (cyclePosition == 14)
        {
            // Third message appears
            isTyping = false;
            messages.Add(new DemoMessage 
            { 
                Text = "Hope your special day is as incredible as you are! üéÅü•≥",
                IsSent = true,
                IsDelivered = false,
                IsRead = false
            });
        }
        else if (cyclePosition == 16)
        {
            // Messages delivered
            currentStep = 2;
            showNotification = true;
            foreach (var msg in messages)
            {
                msg.IsDelivered = true;
            }
        }
        else if (cyclePosition == 19)
        {
            // Messages read
            currentStep = 3;
            showNotification = false;
            foreach (var msg in messages)
            {
                msg.IsRead = true;
            }
            
            // Trigger confetti
            _ = CreateConfetti();
        }
    }

    private async Task CreateConfetti()
    {
        try
        {
            await JS.InvokeVoidAsync("createConfetti");
        }
        catch
        {
            // JS not ready or function not available
        }
    }

    public void Dispose()
    {
        if (_timer != null)
        {
            _timer.Stop();
            _timer.Dispose();
        }
    }
}

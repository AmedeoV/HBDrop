@page "/settings"
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using HBDrop.WebApp.Models
@using HBDrop.WebApp.Data
@* @attribute [Authorize] - Temporarily disabled to test manual redirect *@
@layout DashboardLayout
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject ApplicationDbContext DbContext
@inject IJSRuntime JSRuntime

<PageTitle>Settings - HBDrop</PageTitle>

<div class="settings-container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h2 class="mb-4">‚öôÔ∏è Settings</h2>

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <strong>‚úì Success!</strong> @successMessage
                    <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
                </div>
            }

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>Error!</strong> @errorMessage
                    <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
                </div>
            }

            <!-- Timezone Settings Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">üåç Birthday Notification Settings</h5>
                    <p class="text-muted mb-4">
                        Set your default timezone and preferred time for birthday notifications. 
                        These settings apply to all your contacts unless you override them individually.
                    </p>

                    <EditForm Model="@settingsModel" OnValidSubmit="SaveSettings">
                        <DataAnnotationsValidator />

                        <div class="mb-4">
                            <label class="form-label fw-bold">Your Timezone</label>
                            <InputSelect class="form-select" @bind-Value="settingsModel.TimeZoneId">
                                <option value="">Select your timezone...</option>
                                @foreach (var tz in commonTimeZones)
                                {
                                    <option value="@tz.Id">@tz.DisplayName</option>
                                }
                            </InputSelect>
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i> Birthday messages will be sent according to your local time.
                            </div>
                            <ValidationMessage For="@(() => settingsModel.TimeZoneId)" />
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Preferred Send Time</label>
                            <InputSelect class="form-select" @bind-Value="settingsModel.MessageHour">
                                @for (int hour = 0; hour < 24; hour++)
                                {
                                    var displayTime = FormatHour(hour);
                                    <option value="@hour">@displayTime</option>
                                }
                            </InputSelect>
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i> Birthday wishes will be sent at this time in your timezone.
                            </div>
                            <ValidationMessage For="@(() => settingsModel.MessageHour)" />
                        </div>

                        <div class="alert alert-info">
                            <strong>üí° Tip:</strong> You can override these settings for individual contacts when adding or editing them.
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    <span>Saving...</span>
                                }
                                else
                                {
                                    <span>üíæ Save Settings</span>
                                }
                            </button>
                            <button type="button" class="btn btn-outline-secondary" @onclick="Cancel">
                                Cancel
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>

            <!-- Current Settings Preview -->
            @if (currentUser != null && !string.IsNullOrEmpty(currentUser.DefaultTimeZoneId))
            {
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title">üìç Current Settings</h6>
                        <ul class="list-unstyled mb-0">
                            <li><strong>Timezone:</strong> @currentUser.DefaultTimeZoneId</li>
                            <li><strong>Send Time:</strong> @FormatHour(currentUser.DefaultMessageHour)</li>
                            <li><strong>Current Local Time:</strong> @GetCurrentLocalTime()</li>
                        </ul>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal for asking to update existing contacts -->
@if (showUpdateContactsModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üìã Update Existing Contacts?</h5>
                    <button type="button" class="btn-close" @onclick="() => HandleUpdateContactsChoice(false)"></button>
                </div>
                <div class="modal-body">
                    <p>You've changed your default timezone or send time settings.</p>
                    <p class="fw-bold">Would you like to update your existing @contactCount contact(s) with these new settings?</p>
                    <div class="alert alert-info mb-0">
                        <small>
                            <strong>Note:</strong> This will only update contacts that don't have custom timezone or send time settings.
                            Contacts with custom settings will keep their individual preferences.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => HandleUpdateContactsChoice(false)">
                        No, Keep Current Settings
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="() => HandleUpdateContactsChoice(true)" disabled="@isUpdatingContacts">
                        @if (isUpdatingContacts)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>Updating...</span>
                        }
                        else
                        {
                            <span>Yes, Update Contacts</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private class SettingsModel
    {
        public string? TimeZoneId { get; set; }
        public int MessageHour { get; set; } = 9;
    }

    private class TimeZoneOption
    {
        public string Id { get; set; } = "";
        public string DisplayName { get; set; } = "";
    }

    private SettingsModel settingsModel = new();
    private ApplicationUser? currentUser;
    private bool isSaving = false;
    private string successMessage = "";
    private string errorMessage = "";
    private bool showUpdateContactsModal = false;
    private bool isUpdatingContacts = false;
    private int contactCount = 0;
    private string? oldTimeZoneId;
    private int oldMessageHour;

    private List<TimeZoneOption> commonTimeZones = new()
    {
        new() { Id = "Europe/Dublin", DisplayName = "üáÆüá™ Ireland (Dublin) - GMT/IST" },
        new() { Id = "Europe/London", DisplayName = "üá¨üáß United Kingdom (London) - GMT/BST" },
        new() { Id = "Europe/Paris", DisplayName = "üá´üá∑ France (Paris) - CET/CEST" },
        new() { Id = "Europe/Berlin", DisplayName = "üá©üá™ Germany (Berlin) - CET/CEST" },
        new() { Id = "Europe/Madrid", DisplayName = "üá™üá∏ Spain (Madrid) - CET/CEST" },
        new() { Id = "Europe/Rome", DisplayName = "üáÆüáπ Italy (Rome) - CET/CEST" },
        new() { Id = "Europe/Amsterdam", DisplayName = "üá≥üá± Netherlands (Amsterdam) - CET/CEST" },
        new() { Id = "America/New_York", DisplayName = "üá∫üá∏ USA East (New York) - EST/EDT" },
        new() { Id = "America/Chicago", DisplayName = "üá∫üá∏ USA Central (Chicago) - CST/CDT" },
        new() { Id = "America/Denver", DisplayName = "üá∫üá∏ USA Mountain (Denver) - MST/MDT" },
        new() { Id = "America/Los_Angeles", DisplayName = "üá∫üá∏ USA West (Los Angeles) - PST/PDT" },
        new() { Id = "America/Toronto", DisplayName = "üá®üá¶ Canada (Toronto) - EST/EDT" },
        new() { Id = "America/Vancouver", DisplayName = "üá®üá¶ Canada (Vancouver) - PST/PDT" },
        new() { Id = "America/Mexico_City", DisplayName = "üá≤üáΩ Mexico (Mexico City) - CST/CDT" },
        new() { Id = "America/Sao_Paulo", DisplayName = "üáßüá∑ Brazil (S√£o Paulo) - BRT" },
        new() { Id = "Australia/Sydney", DisplayName = "üá¶üá∫ Australia (Sydney) - AEST/AEDT" },
        new() { Id = "Australia/Melbourne", DisplayName = "üá¶üá∫ Australia (Melbourne) - AEST/AEDT" },
        new() { Id = "Pacific/Auckland", DisplayName = "üá≥üáø New Zealand (Auckland) - NZST/NZDT" },
        new() { Id = "Asia/Tokyo", DisplayName = "üáØüáµ Japan (Tokyo) - JST" },
        new() { Id = "Asia/Seoul", DisplayName = "üá∞üá∑ South Korea (Seoul) - KST" },
        new() { Id = "Asia/Shanghai", DisplayName = "üá®üá≥ China (Shanghai) - CST" },
        new() { Id = "Asia/Hong_Kong", DisplayName = "üá≠üá∞ Hong Kong - HKT" },
        new() { Id = "Asia/Dubai", DisplayName = "üá¶üá™ UAE (Dubai) - GST" },
        new() { Id = "Asia/Singapore", DisplayName = "üá∏üá¨ Singapore - SGT" },
        new() { Id = "Asia/Bangkok", DisplayName = "üáπüá≠ Thailand (Bangkok) - ICT" },
        new() { Id = "Asia/Kolkata", DisplayName = "üáÆüá≥ India (Kolkata) - IST" },
    };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            Navigation.NavigateTo("/", forceLoad: true);
            return;
        }

        currentUser = await UserManager.GetUserAsync(user);
        if (currentUser != null)
        {
            // Load current settings and store old values
            oldTimeZoneId = currentUser.DefaultTimeZoneId;
            oldMessageHour = currentUser.DefaultMessageHour;
            settingsModel.TimeZoneId = currentUser.DefaultTimeZoneId;
            settingsModel.MessageHour = currentUser.DefaultMessageHour;
            
            // Count contacts to show in modal
            contactCount = await DbContext.Contacts
                .Where(c => c.UserId == currentUser.Id)
                .CountAsync();
        }
    }

    private async Task SaveSettings()
    {
        if (currentUser == null) return;

        isSaving = true;
        errorMessage = "";
        successMessage = "";

        try
        {
            // Store OLD values before updating (these are what contacts currently have)
            oldTimeZoneId = currentUser.DefaultTimeZoneId;
            oldMessageHour = currentUser.DefaultMessageHour;
            
            // Check if timezone or message hour changed
            bool settingsChanged = currentUser.DefaultTimeZoneId != settingsModel.TimeZoneId ||
                                   currentUser.DefaultMessageHour != settingsModel.MessageHour;

            currentUser.DefaultTimeZoneId = settingsModel.TimeZoneId;
            currentUser.DefaultMessageHour = settingsModel.MessageHour;

            var result = await UserManager.UpdateAsync(currentUser);

            if (result.Succeeded)
            {
                // If settings changed and user has contacts, ask if they want to update them
                if (settingsChanged && contactCount > 0)
                {
                    showUpdateContactsModal = true;
                }
                else
                {
                    successMessage = "Your settings have been saved successfully!";
                }
            }
            else
            {
                errorMessage = "Failed to save settings: " + string.Join(", ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task HandleUpdateContactsChoice(bool updateContacts)
    {
        showUpdateContactsModal = false;

        if (updateContacts && currentUser != null)
        {
            isUpdatingContacts = true;
            try
            {
                // Update contacts that don't have custom settings
                // A contact uses default settings if TimeZoneId is null or empty and PreferredMessageHour is -1 or matches old default
                var contactsToUpdate = await DbContext.Contacts
                    .Where(c => c.UserId == currentUser.Id)
                    .ToListAsync();

                int updatedCount = 0;
                foreach (var contact in contactsToUpdate)
                {
                    bool needsUpdate = false;
                    bool isUsingDefaults = string.IsNullOrWhiteSpace(contact.TimeZoneId) || contact.TimeZoneId == oldTimeZoneId;

                    // If contact is using default timezone, update both timezone and message hour
                    if (isUsingDefaults)
                    {
                        // Update timezone
                        if (currentUser.DefaultTimeZoneId != settingsModel.TimeZoneId)
                        {
                            contact.TimeZoneId = settingsModel.TimeZoneId;
                            needsUpdate = true;
                        }

                        // Update message hour (regardless of what it currently is, since timezone change affects all defaults)
                        if (currentUser.DefaultMessageHour != settingsModel.MessageHour)
                        {
                            contact.PreferredMessageHour = settingsModel.MessageHour;
                            needsUpdate = true;
                        }
                    }

                    if (needsUpdate)
                    {
                        updatedCount++;
                    }
                }

                if (updatedCount > 0)
                {
                    await DbContext.SaveChangesAsync();
                    successMessage = $"Your settings have been saved and {updatedCount} contact(s) have been updated!";
                }
                else
                {
                    successMessage = "Your settings have been saved! (No contacts needed updating)";
                }
            }
            catch (Exception ex)
            {
                errorMessage = $"Settings saved, but failed to update contacts: {ex.Message}";
            }
            finally
            {
                isUpdatingContacts = false;
            }
        }
        else
        {
            successMessage = "Your settings have been saved successfully!";
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/dashboard");
    }

    private string FormatHour(int hour)
    {
        if (hour == 0) return "12:00 AM (Midnight)";
        if (hour == 12) return "12:00 PM (Noon)";
        if (hour < 12) return $"{hour}:00 AM";
        return $"{hour - 12}:00 PM";
    }

    private string GetCurrentLocalTime()
    {
        if (currentUser == null || string.IsNullOrEmpty(currentUser.DefaultTimeZoneId))
            return "N/A";

        try
        {
            var timeZone = TimeZoneInfo.FindSystemTimeZoneById(currentUser.DefaultTimeZoneId);
            var localTime = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, timeZone);
            return localTime.ToString("HH:mm:ss (dddd, MMMM dd, yyyy)");
        }
        catch
        {
            return "Invalid timezone";
        }
    }
}

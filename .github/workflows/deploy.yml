name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment package
        run: |
          tar czf deploy.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='bin' \
            --exclude='obj' \
            --exclude='.env' \
            --exclude='*.user' \
            . || true

      - name: Copy to server
        run: |
          scp deploy.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.DEPLOY_PATH }}/

      - name: Deploy on server
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "bash -s" << 'ENDSSH'
            set -e
            cd ${{ secrets.DEPLOY_PATH }}
            
            echo "Extracting deployment package..."
            tar xzf deploy.tar.gz
            rm deploy.tar.gz
            
            echo "Copying docker-compose from example..."
            cp docker-compose.example.yml docker-compose.yml
            
            echo "Creating .env file..."
            cat > .env << 'ENVEOF'
          ENCRYPTION_MASTER_KEY=${{ secrets.ENCRYPTION_MASTER_KEY }}
          GIPHY_API_KEY=${{ secrets.GIPHY_API_KEY }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          ENVEOF
            
            echo "Updating appsettings.json with production secrets..."
            sed -i "s|PLACEHOLDER_PASSWORD|${{ secrets.POSTGRES_PASSWORD }}|g" HBDrop.WebApp/appsettings.json
            sed -i "s|PLACEHOLDER_ENCRYPTION_KEY|${{ secrets.ENCRYPTION_MASTER_KEY }}|g" HBDrop.WebApp/appsettings.json
            sed -i "s|PLACEHOLDER_GIPHY_KEY|${{ secrets.GIPHY_API_KEY }}|g" HBDrop.WebApp/appsettings.json
            
            echo "Building new images..."
            docker-compose build --no-cache webapp
            
            echo "Performing rolling update (zero downtime)..."
            docker-compose up -d --no-deps webapp
            
            echo "Waiting for webapp to be healthy..."
            timeout=60
            elapsed=0
            while [ $elapsed -lt $timeout ]; do
              if docker-compose ps webapp | grep -q "healthy"; then
                echo "Webapp is healthy!"
                break
              fi
              echo "Waiting for webapp to become healthy... ($elapsed/$timeout seconds)"
              sleep 5
              elapsed=$((elapsed + 5))
            done
            
            echo "Cleaning up old images..."
            docker image prune -f
            
            echo "Deployment complete!"
            docker-compose ps
          ENDSSH

      - name: Verify deployment
        run: |
          sleep 15
          echo "Checking container status..."
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ${{ secrets.DEPLOY_PATH }} && docker-compose ps && docker-compose logs --tail=30 webapp"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful to hbdrop.step0fail.com"
          else
            echo "❌ Deployment failed"
          fi
